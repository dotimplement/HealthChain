# Sandbox Client

The sandbox client provides a simplified interface for testing and validating your applications in realistic healthcare contexts. Use `SandboxClient` to quickly spin up demos and test with various data sources and workflows.

## Quick Example

Test CDS Hooks workflows with synthetic data:

```python
from healthchain.sandbox import SandboxClient

# Create client with full service URL and workflow
client = SandboxClient(
    url="http://localhost:8000/cds/cds-services/my-service",
    workflow="encounter-discharge"
)

# Load data and send requests
client.load_from_registry(
    "synthea-patient",
    data_dir="./data/synthea",
    resource_types=["Condition", "MedicationStatement"],
    sample_size=5
    )
responses = client.send_requests()
```

## SandboxClient

### Initializing

```python
from healthchain.sandbox import SandboxClient

client = SandboxClient(
    url="http://localhost:8000/cds/cds-services/my-service",
    workflow="encounter-discharge",  # Required
    protocol="rest",  # "rest" for CDS Hooks, "soap" for CDA
    timeout=10.0
)
```

### Workflow-Protocol Compatibility

The client validates workflow-protocol combinations at initialization:

| Protocol | Compatible Workflows |
|----------|---------------------|
| **REST** | `patient-view`, `encounter-discharge`, `order-select`, `order-sign` |
| **SOAP** | `sign-note-inpatient`, `sign-note-outpatient` |


### Loading Data

=== "From Registry"
    ```python
    # Load from pre-configured datasets
    client.load_from_registry(
        "mimic-on-fhir",
        data_dir="./data/mimic-fhir",
        resource_types=["MimicMedication"],
        sample_size=10
    )

    # Available datasets: "mimic-on-fhir", "synthea-patient"
    ```

=== "From Files"
    ```python
    # Load single file
    client.load_from_path("./data/clinical_note.xml")

    # Load directory with glob pattern
    client.load_from_path("./data/cda_files/", pattern="*.xml")
    ```

=== "From Free Text CSV"
    ```python
    # Generate synthetic FHIR from clinical notes
    client.load_free_text(
        csv_path="./data/discharge_notes.csv",
        column_name="text",
        generate_synthetic=True,  # Include synthetic FHIR resources
        random_seed=42
    )
    ```

## Dataset Loaders

HealthChain provides two pre-configured dataset loaders for testing with common FHIR testing datasets. Use `load_from_registry()` to access these datasets.

### Overview

| Dataset | Type | Use Case | File Format |
|---------|------|----------|-------------|
| **MIMIC-on-FHIR** | Real de-identified | Testing with realistic clinical patterns | `.ndjson.gz` per resource type |
| **Synthea** | Synthetic | Quick demos, single patient testing | `.json` Bundle per patient |


**When to use:**

- **MIMIC**: Test with real-world data distributions and clinical patterns from a major hospital
- **Synthea**: Quick demos without downloading large datasets; ideal for single-patient workflows

### MIMIC-on-FHIR Loader

Real de-identified clinical data from Beth Israel Deaconess Medical Center in FHIR R4 format.

**Directory Structure:**

```
data_dir/
└── fhir/
    ├── MimicMedication.ndjson.gz
    ├── MimicCondition.ndjson.gz
    ├── MimicObservation.ndjson.gz
    └── ... (other resource types)
```

**Usage:**

=== "Basic"
    ```python
    client.load_from_registry(
        "mimic-on-fhir",
        data_dir="./data/mimic-iv-fhir",
        resource_types=["MimicMedication", "MimicCondition"]
    )
    ```

=== "With Sampling"
    ```python
    # Load random sample for faster testing
    client.load_from_registry(
        "mimic-on-fhir",
        data_dir="./data/mimic-iv-fhir",
        resource_types=["MimicMedication", "MimicObservation"],
        sample_size=5,  # 5 resources per type
        random_seed=42   # Reproducible sampling
    )
    ```

**Available Resource Types:**

`MimicMedication`, `MimicCondition`, `MimicObservation`, `MimicProcedure`, `MimicEncounter`, `MimicPatient`, and more. Check your dataset's `/fhir` directory for available types.

!!! note "Setup Requirements"
    The full MIMIC-on-FHIR dataset requires credentialed PhysioNet access, but you can download the [demo dataset without credentials](https://physionet.org/content/mimic-iv-fhir-demo/2.1.0/) (100 patients).

### Synthea Loader

Synthetic patient data generated by Synthea, containing realistic FHIR Bundles (typically 100-500 resources per patient).

**Directory Structure:**

```
data_dir/
├── FirstName123_LastName456_uuid.json
├── FirstName789_LastName012_uuid.json
└── ... (one .json file per patient)
```

**Usage:**

=== "First Patient (Quick Demo)"
    ```python
    # Automatically loads first .json file found
    client.load_from_registry(
        "synthea-patient",
        data_dir="./synthea_sample_data_fhir_latest"
        resource_type=["Condition"],  # Finds all Condition resources, loads all if not specified
    )
    ```

=== "By Patient ID"
    ```python
    client.load_from_registry(
        "synthea-patient",
        data_dir="./synthea_sample_data_fhir_latest",
        patient_id="a969c177-a995-7b89-7b6d-885214dfa253",
        resource_type=["Condition"],
    )
    ```

=== "With Resource Filtering"
    ```python
    # Load specific resource types with sampling
    client.load_from_registry(
        "synthea-patient",
        data_dir="./synthea_sample_data_fhir_latest",
        resource_types=["Condition", "MedicationRequest", "Observation"],
        sample_size=5,  # 5 resources per type
        random_seed=42,
    )
    ```


!!! tip "Getting Synthea Data"
    Generate synthetic patients using [Synthea](https://github.com/synthetichealth/synthea) or [download sample data](https://synthea.mitre.org/downloads) from their releases. Each patient Bundle is self-contained with all clinical history.

### Managing Requests

```python
# Preview queued requests before sending
previews = client.preview_requests(limit=3)
for preview in previews:
    print(f"Request {preview['index']}: {preview['type']}")

# Get full request data for inspection
requests_dict = client.get_request_data(format="dict")
requests_json = client.get_request_data(format="json")
requests_raw = client.get_request_data(format="raw")

# Clear queued requests to start fresh
client.clear_requests()
client.load_from_path("./different_data.xml")
```

### Sending Requests

```python
# Send all queued requests
responses = client.send_requests()

# Save results to disk
client.save_results("./output/")

# Get client status
status = client.get_status()
print(status)
# {
#     "sandbox_id": "...",
#     "url": "http://localhost:8000/cds/...",
#     "protocol": "rest",
#     "workflow": "encounter-discharge",
#     "requests_queued": 5,
#     "responses_received": 5
# }
```

### Using Context Manager

For automatic result saving on successful completion:

```python
with SandboxClient(
    url="http://localhost:8000/cds/cds-services/my-service",
    workflow="encounter-discharge"
) as client:
    client.load_free_text(
        csv_path="./data/notes.csv",
        column_name="text"
    )
    responses = client.send_requests()
    # Results automatically saved to ./output/ on successful exit
```

## Complete Examples

=== "CDS Hooks Test"
    ```python
    from healthchain.sandbox import SandboxClient

    # Initialize for CDS Hooks
    client = SandboxClient(
        url="http://localhost:8000/cds/cds-services/sepsis-alert",
        workflow="patient-view"
    )

    # Load and send
    client.load_from_registry(
        "mimic-on-fhir",
        data_dir="./data/mimic-iv-fhir",
        resource_types=["MimicConditionED", "MimicObservation"],
        sample_size=10,

    responses = client.send_requests()
    client.save_results("./output/")
    ```

=== "Clinical Documentation Test"
    ```python
    from healthchain.sandbox import SandboxClient

    # Initialize for SOAP/CDA
    client = SandboxClient(
        url="http://localhost:8000/notereader/ProcessDocument/",
        workflow="sign-note-inpatient",
        protocol="soap"
    )

    # Load CDA files from directory
    client.load_from_path("./data/cda_files/", pattern="*.xml")
    responses = client.send_requests()
    client.save_results("./output/")
    ```

=== "Free Text CSV"
    ```python
    from healthchain.sandbox import SandboxClient

    # Initialize client
    client = SandboxClient(
        url="http://localhost:8000/cds/cds-services/my-service",
        workflow="patient-view"
    )

    # Load text data
    client.load_free_text(
        csv_path="./data/clinical_notes.csv",
        column_name="note_text",
        generate_synthetic=True
    )

    # Send and save
    responses = client.send_requests()
    client.save_results("./output/")
    ```

## Migration Guide

!!! warning "Decorator Pattern Deprecated"
    The `@hc.sandbox` and `@hc.ehr` decorators with `ClinicalDecisionSupport` and `ClinicalDocumentation` base classes are deprecated. Use `SandboxClient` instead.

**Before:**

```python
@hc.sandbox
class TestCDS(ClinicalDecisionSupport):
    @hc.ehr(workflow="patient-view")
    def load_data(self):
        return prefetch_data
```

**After:**

```python
client = SandboxClient(
    url="http://localhost:8000/cds/cds-services/my-service",
    workflow="patient-view"
)
client.load_from_registry(
    "synthea-patient",
    data_dir="./data/synthea",
    resource_types=["Condition", "Observation"],
    sample_size=10
)
responses = client.send_requests()
```
