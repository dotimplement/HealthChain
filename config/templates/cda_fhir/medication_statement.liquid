{
  "resourceType": "MedicationStatement",
  "id": "{{ entry.id | generate_id }}",
  "status": "{{ entry.statusCode | map_status: 'cda_to_fhir' | default: 'recorded' }}",
  "medication": {
    "concept": {
      "coding": [{
        "system": "{{ entry.substanceAdministration.consumable.manufacturedProduct.manufacturedMaterial.code['@codeSystem'] | map_system: 'cda_to_fhir' }}",
        "code": "{{ entry.substanceAdministration.consumable.manufacturedProduct.manufacturedMaterial.code['@code'] }}",
        "display": "{{ entry.substanceAdministration.consumable.manufacturedProduct.manufacturedMaterial.code['@displayName'] }}"
      }]
    }
  }

  {% comment %}Process effectiveTime and extract period/timing information if exists{% endcomment %}
  {% if entry.substanceAdministration.effectiveTime %}
    ,
    {% assign effective_period = entry.substanceAdministration.effectiveTime | extract_effective_period %}
    {% if effective_period %}
      "effectivePeriod": {
        {% if effective_period.start %}"start": "{{ effective_period.start }}"{% if effective_period.end %},{% endif %}{% endif %}
        {% if effective_period.end %}"end": "{{ effective_period.end }}"{% endif %}
      }
      {% assign effective_timing = entry.substanceAdministration.effectiveTime | extract_effective_timing %}
      {% if entry.substanceAdministration.doseQuantity or entry.substanceAdministration.routeCode or effective_timing %},{% endif %}
    {% endif %}
  {% endif %}

  {% comment %}Add dosage if any dosage related fields are present{% endcomment %}
  {% assign effective_timing = entry.substanceAdministration.effectiveTime | extract_effective_timing %}
  {% if entry.substanceAdministration.doseQuantity or entry.substanceAdministration.routeCode or effective_timing %}
    {% if entry.substanceAdministration.effectiveTime == nil %},{% endif %}
    "dosage": [
      {
        {% if entry.substanceAdministration.doseQuantity %}
          "doseAndRate": [
            {
              "doseQuantity": {
                "value": {{ entry.substanceAdministration.doseQuantity['@value'] }},
                "unit": "{{ entry.substanceAdministration.doseQuantity['@unit'] }}"
              }
            }
          ]{% if entry.substanceAdministration.routeCode or effective_timing %},{% endif %}
        {% endif %}

        {% if entry.substanceAdministration.routeCode %}
          "route": {
            "coding": [
              {
                "system": "{{ entry.substanceAdministration.routeCode['@codeSystem'] | map_system: 'cda_to_fhir' }}",
                "code": "{{ entry.substanceAdministration.routeCode['@code'] }}",
                "display": "{{ entry.substanceAdministration.routeCode['@displayName'] }}"
              }
            ]
          }{% if effective_timing %},{% endif %}
        {% endif %}

        {% if effective_timing %}
          "timing": {
            "repeat": {
              "period": {{ effective_timing.period }},
              "periodUnit": "{{ effective_timing.periodUnit }}"
            }
          }
        {% endif %}
      }
    ]
  {% endif %}

  ,
  "subject": {
    "reference": "Patient/{{ entry.subject_id | default: '123' }}"
  }
}
