{
  "act": {
    "@classCode": "ACT",
    "@moodCode": "EVN",
    "templateId": [
    {% for template_id in config.template.act.template_ids %}
      {"@root": "{{template_id}}"} {% if forloop.last != true %},{% endif %}
    {% endfor %}
    ],
    "id": {"@root": "{{ resource.id | generate_id }}"},
    "code": {"@nullFlavor": "NA"},
    "statusCode": {
      "@code": "{{ config.template.act.status_code | default: config.defaults.status_code }}"
    },
    "effectiveTime": {
      "low": {"@value": "{{ timestamp }}"}
    },
    "entryRelationship": {
      "@typeCode": "{{ config.template.problem_obs.type_code | default: config.defaults.type_code }}",
      "@inversionInd": {{ config.template.problem_obs.inversion_ind | default: config.defaults.inversion_ind }},
      "observation": {
        "@classCode": "OBS",
        "@moodCode": "EVN",
        "templateId": [
        {% for template_id in config.template.problem_obs.template_ids %}
          {"@root": "{{template_id}}"} {% if forloop.last != true %},{% endif %}
        {% endfor %}
        ],
        "id": {"@root": "{{ resource.id }}_obs"},
        "code": {
          "@code": "{{ config.template.problem_obs.code | default: config.defaults.problem_code }}",
          "@codeSystem": "{{ config.template.problem_obs.code_system | default: config.defaults.problem_code_system }}",
          "@codeSystemName": "{{ config.template.problem_obs.code_system_name | default: config.defaults.problem_code_system_name }}",
          "@displayName": "{{ config.template.problem_obs.display_name | default: config.defaults.problem_display_name }}"
        },
        "text": {
          "reference": {"@value": "{{ text_reference_name }}"}
        },
        "statusCode": {"@code": "{{ config.template.problem_obs.status_code | default: 'completed' }}"},
        "effectiveTime": {
          {% if resource.onsetDateTime %}
          "low": {"@value": "{{ resource.onsetDateTime }}"}
          {% endif %}
          {% if resource.abatementDateTime %}
          "high": {"@value": "{{ resource.abatementDateTime }}"}
          {% endif %}
        },
        "value": {
          "@xmlns:xsi": "http://www.w3.org/2001/XMLSchema-instance",
          "@xsi:type": "CD",
          "@code": "{{ resource.code.coding[0].code }}",
          "@codeSystem": "{{ resource.code.coding[0].system | map_system: 'fhir_to_cda' }}",
          "@displayName": "{{ resource.code.coding[0].display }}",
          "originalText": {
            "reference": {"@value": "{{ text_reference_name }}"}
          }
        },
        "entryRelationship": {
          "@typeCode": "REFR",
          "observation": {
            "@classCode": "OBS",
            "@moodCode": "EVN",
            "code": {
              "@code": "{{ config.template.clinical_status_obs.code | default: '33999-4' }}",
              "@codeSystem": "{{ config.template.clinical_status_obs.code_system | default: '2.16.840.1.113883.6.1' }}",
              "@codeSystemName": "{{config.template.clinical_status_obs.code_system_name | default: 'LOINC'}}",
              "@displayName": "{{ config.template.clinical_status_obs.display_name | default: 'Status' }}"
            },
            "value": {
              "@xmlns:xsi": "http://www.w3.org/2001/XMLSchema-instance",
              "@code": "{{ resource.clinicalStatus.coding[0].code | map_status: 'fhir_to_cda' }}",
              "@codeSystem": "{{ resource.clinicalStatus.coding[0].system | map_system: 'fhir_to_cda' }}",
              "@displayName": "{{ resource.clinicalStatus.coding[0].display }}",
              "@xsi:type": "CE"
            },
            "statusCode": {"@code": "{{ config.template.clinical_status_obs.status_code | default: 'completed' }}"},
            "effectiveTime": {
              "low": {"@value": "{{ timestamp }}"}
            }
          }
        }
      }
    }
  }
}
